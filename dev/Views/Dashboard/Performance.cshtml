@{
    ViewData["Title"] = "Performance Dashboard";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Performance Dashboard</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Date and Location Filters -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" value="@DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" value="@DateTime.Today.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-4">
                            <label for="locationSelect" class="form-label">Location</label>
                            <select class="form-select" id="locationSelect">
                                <option value="all">All Locations</option>
                                <option value="all_stores">Physical Stores Only</option>
                                <option value="ecom">E-commerce Only</option>
                                <option value="tyrone">Tyrone</option>
                                <option value="oldstpete">Old St Pete</option>
                                <option value="mallofgeorgia">Mall of Georgia</option>
                                <option value="altamonte">Altamonte</option>
                                <option value="coconutcreek">Coconut Creek</option>
                                <option value="weston">Weston</option>
                                <option value="brandon">Brandon</option>
                                <option value="lakeland">Lakeland</option>
                                <option value="tampa">Tampa</option>
                                <option value="orlando">Orlando</option>
                                <option value="sarasota">Sarasota</option>
                                <option value="jacksonville">Jacksonville</option>
                                <option value="gainesville">Gainesville</option>
                                <option value="tallahassee">Tallahassee</option>
                                <option value="bocaraton">Boca Raton</option>
                                <option value="pinecrest">Pinecrest</option>
                                <option value="davie">Davie</option>
                                <option value="clearwater">Clearwater</option>
                                <option value="wesley">Wesley Chapel</option>
                                <option value="barceloneta">Barceloneta (PR)</option>
                                <option value="mayaguez">Mayaguez (PR)</option>
                                <option value="fajardo">Fajardo (PR)</option>
                                <option value="plazacarolina">Plaza Carolina (PR)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadPerformanceData()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center mb-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading performance data...</p>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4" id="metricsCards">
        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Orders</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalOrders">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Revenue</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Avg Order Value</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgOrderValue">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calculator fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Unique Customers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="uniqueCustomers">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Conversion Rate</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="conversionRate">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-dark shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">Revenue/Visitor</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="revenuePerVisitor">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Daily Revenue Trend -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Daily Revenue Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Conversion Rate Trend -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Conversion Rate Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="conversionChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Revenue per Visitor Trend -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">Revenue per Visitor Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="revenuePerVisitorChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Visitors vs Orders -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Visitors vs Orders</h6>
                </div>
                <div class="card-body">
                    <canvas id="visitorsVsOrdersChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Performance Table -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Store Performance Summary</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="storePerformanceTable">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                    <th>Avg Order Value</th>
                                    <th>Unique Customers</th>
                                    <th>Visitors</th>
                                    <th>Conversion Rate</th>
                                    <th>Revenue/Visitor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="text-center">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart, conversionChart, revenuePerVisitorChart, visitorsVsOrdersChart;

        document.addEventListener('DOMContentLoaded', function() {
            loadPerformanceData();
        });

        async function loadPerformanceData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const location = document.getElementById('locationSelect').value;

            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const response = await fetch(`/dev/api/performance?startDate=${startDate}&endDate=${endDate}&location=${location}`);
                const data = await response.json();

                if (response.ok) {
                    updateMetrics(data.metrics);
                    updateCharts(data.dailyPerformance);
                    updateStoreTable(data.storePerformance);
                } else {
                    console.error('Error loading performance data:', data.error);
                    alert('Error loading performance data: ' + (data.message || data.error));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading performance data');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function updateMetrics(metrics) {
            document.getElementById('totalOrders').textContent = metrics.totalOrders.toLocaleString();
            document.getElementById('totalRevenue').textContent = '$' + metrics.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('avgOrderValue').textContent = '$' + metrics.avgOrderValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('uniqueCustomers').textContent = metrics.uniqueCustomers.toLocaleString();
            document.getElementById('conversionRate').textContent = metrics.conversionRate ? metrics.conversionRate.toFixed(2) + '%' : 'N/A';
            document.getElementById('revenuePerVisitor').textContent = metrics.revenuePerVisitor ? '$' + metrics.revenuePerVisitor.toFixed(2) : 'N/A';
        }

        function updateCharts(dailyData) {
            const labels = dailyData.map(d => new Date(d.date).toLocaleDateString());
            const revenues = dailyData.map(d => d.revenue);
            const conversionRates = dailyData.map(d => d.conversionRate);
            const revenuePerVisitors = dailyData.map(d => d.revenuePerVisitor);
            const visitors = dailyData.map(d => d.totalVisitors);
            const orders = dailyData.map(d => d.orders);

            // Destroy existing charts
            if (revenueChart) revenueChart.destroy();
            if (conversionChart) conversionChart.destroy();
            if (revenuePerVisitorChart) revenuePerVisitorChart.destroy();
            if (visitorsVsOrdersChart) visitorsVsOrdersChart.destroy();

            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Revenue',
                        data: revenues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Conversion Rate Chart
            const conversionCtx = document.getElementById('conversionChart').getContext('2d');
            conversionChart = new Chart(conversionCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversion Rate (%)',
                        data: conversionRates,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Revenue per Visitor Chart
            const revenuePerVisitorCtx = document.getElementById('revenuePerVisitorChart').getContext('2d');
            revenuePerVisitorChart = new Chart(revenuePerVisitorCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue per Visitor ($)',
                        data: revenuePerVisitors,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Visitors vs Orders Chart
            const visitorsVsOrdersCtx = document.getElementById('visitorsVsOrdersChart').getContext('2d');
            visitorsVsOrdersChart = new Chart(visitorsVsOrdersCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visitors',
                        data: visitors,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        yAxisID: 'y',
                        spanGaps: true
                    }, {
                        label: 'Orders',
                        data: orders,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function updateStoreTable(storeData) {
            const tbody = document.querySelector('#storePerformanceTable tbody');
            tbody.innerHTML = '';

            if (storeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No data available</td></tr>';
                return;
            }

            storeData.forEach(store => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${store.location}</strong></td>
                    <td>${store.totalOrders.toLocaleString()}</td>
                    <td>$${store.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>$${store.avgOrderValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${store.uniqueCustomers.toLocaleString()}</td>
                    <td>${store.totalVisitors ? store.totalVisitors.toLocaleString() : 'N/A'}</td>
                    <td>${store.conversionRate ? store.conversionRate.toFixed(2) + '%' : 'N/A'}</td>
                    <td>${store.revenuePerVisitor ? '$' + store.revenuePerVisitor.toFixed(2) : 'N/A'}</td>
                `;
            });
        }

        function refreshData() {
            loadPerformanceData();
        }
    </script>
}